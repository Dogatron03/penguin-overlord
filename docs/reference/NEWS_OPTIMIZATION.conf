# News System Optimization Configuration
# 
# This file contains the optimal scheduling configuration for the news aggregation system.
# Each category runs at staggered intervals to distribute load.

## Staggered Schedule Overview
# 
# Category       Interval  Minute Offset  Example Times (24h)
# -----------    --------  -------------  ----------------------------------
# CVE            6 hours   :00            00:00, 06:00, 12:00, 18:00
# Cybersecurity  3 hours   :01            00:01, 03:01, 06:01, 09:01, 12:01...
# Tech           4 hours   :30            00:30, 04:30, 08:30, 12:30, 16:30...
# Gaming         2 hours   :15            00:15, 02:15, 04:15, 06:15, 08:15...
# Apple/Google   3 hours   :45            00:45, 03:45, 06:45, 09:45, 12:45...

## Systemd Timer Configuration
#
# For efficient resource usage, create systemd timers instead of long-running processes.
# Place these files in /etc/systemd/system/ or ~/.config/systemd/user/

# --- CVE Timer ---
# File: penguin-news-cve.timer
[Unit]
Description=Penguin Bot CVE News Fetcher (Every 6 hours)
Requires=penguin-news-cve.service

[Timer]
OnCalendar=*-*-* 00,06,12,18:00:00
Persistent=true
AccuracySec=1min

[Install]
WantedBy=timers.target

# --- Cybersecurity Timer ---
# File: penguin-news-cybersecurity.timer
[Unit]
Description=Penguin Bot Cybersecurity News Fetcher (Every 3 hours)
Requires=penguin-news-cybersecurity.service

[Timer]
OnCalendar=*-*-* 00,03,06,09,12,15,18,21:01:00
Persistent=true
AccuracySec=1min

[Install]
WantedBy=timers.target

# --- Tech Timer ---
# File: penguin-news-tech.timer
[Unit]
Description=Penguin Bot Tech News Fetcher (Every 4 hours)
Requires=penguin-news-tech.service

[Timer]
OnCalendar=*-*-* 00,04,08,12,16,20:30:00
Persistent=true
AccuracySec=1min

[Install]
WantedBy=timers.target

# --- Gaming Timer ---
# File: penguin-news-gaming.timer
[Unit]
Description=Penguin Bot Gaming News Fetcher (Every 2 hours)
Requires=penguin-news-gaming.service

[Timer]
OnCalendar=*-*-* */2:15:00
Persistent=true
AccuracySec=1min

[Install]
WantedBy=timers.target

# --- Apple/Google Timer ---
# File: penguin-news-applegoogle.timer
[Unit]
Description=Penguin Bot Apple/Google News Fetcher (Every 3 hours)
Requires=penguin-news-applegoogle.service

[Timer]
OnCalendar=*-*-* 00,03,06,09,12,15,18,21:45:00
Persistent=true
AccuracySec=1min

[Install]
WantedBy=timers.target

## Service Template
#
# Create corresponding .service files for each timer
# Example: penguin-news-cve.service

[Unit]
Description=Penguin Bot News Fetcher - %I
After=network.target

[Service]
Type=oneshot
User=penguin
Group=penguin
WorkingDirectory=/opt/penguin-overlord
Environment="CATEGORY=%I"
ExecStart=/usr/bin/python3 -m cogs.news_runner --category ${CATEGORY}
StandardOutput=journal
StandardError=journal
SyslogIdentifier=penguin-news-%I

# Resource limits
MemoryMax=256M
CPUQuota=50%
TasksMax=50

[Install]
WantedBy=multi-user.target

## Cron Alternative (if systemd timers not available)
#
# Add to crontab: crontab -e

# CVE - Every 6 hours at :00
0 */6 * * * /usr/bin/python3 /opt/penguin-overlord/cogs/news_runner.py --category cve >> /var/log/penguin-news-cve.log 2>&1

# Cybersecurity - Every 3 hours at :01
1 */3 * * * /usr/bin/python3 /opt/penguin-overlord/cogs/news_runner.py --category cybersecurity >> /var/log/penguin-news-security.log 2>&1

# Tech - Every 4 hours at :30
30 */4 * * * /usr/bin/python3 /opt/penguin-overlord/cogs/news_runner.py --category tech >> /var/log/penguin-news-tech.log 2>&1

# Gaming - Every 2 hours at :15
15 */2 * * * /usr/bin/python3 /opt/penguin-overlord/cogs/news_runner.py --category gaming >> /var/log/penguin-news-gaming.log 2>&1

# Apple/Google - Every 3 hours at :45
45 */3 * * * /usr/bin/python3 /opt/penguin-overlord/cogs/news_runner.py --category applegoogle >> /var/log/penguin-news-applegoogle.log 2>&1

## Log Rotation
#
# File: /etc/logrotate.d/penguin-news

/var/log/penguin-news-*.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 0640 penguin penguin
    sharedscripts
    postrotate
        systemctl reload rsyslog > /dev/null 2>&1 || true
    endscript
}

## Performance Tuning

### Cache Management
# - ETag cache stored in: data/feed_cache.json
# - GUID cache keeps last 50 items per feed
# - Cache file automatically pruned to prevent growth

### Concurrency Limits
# - CVE: 3 concurrent requests (JSON APIs, slower)
# - Cybersecurity: 5 concurrent requests
# - Tech: 5 concurrent requests
# - Gaming: 5 concurrent requests
# - Apple/Google: 5 concurrent requests

### Memory Usage
# - Each category runner: ~50-150MB peak
# - ETag cache: ~5-10MB
# - Total system impact: Minimal (runs briefly then exits)

### Network Usage
# - With ETag caching: 304 responses skip downloads (~99% reduction)
# - Without cache: ~1-5MB per category per run
# - With cache: ~10-100KB per category per run (headers only)

## Monitoring Commands

# Check timer status
systemctl list-timers penguin-news-*

# View logs
journalctl -u penguin-news-cve -f
journalctl -u penguin-news-cybersecurity -f

# Manual trigger
systemctl start penguin-news-cve.service

# Enable timers on boot
systemctl enable penguin-news-cve.timer
systemctl enable penguin-news-cybersecurity.timer
systemctl enable penguin-news-tech.timer
systemctl enable penguin-news-gaming.timer
systemctl enable penguin-news-applegoogle.timer

## Database Alternative (Future Enhancement)
#
# For even better performance, consider SQLite for GUID tracking:
#
# CREATE TABLE feed_items (
#     feed_url TEXT NOT NULL,
#     guid TEXT NOT NULL,
#     posted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
#     PRIMARY KEY (feed_url, guid)
# );
# CREATE INDEX idx_posted_at ON feed_items(posted_at);
#
# Prune old entries weekly:
# DELETE FROM feed_items WHERE posted_at < datetime('now', '-30 days');
